<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>u-doom: Streaming Doom over BLE to a WebBluetooth application</title>
    <link rel="icon" type="image/png" href="images/favicon.ico">
    <link rel="stylesheet" href="css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <header class="grow-w">
        <div>
            <div class="container">
                <div class="row">
                    <div class="col-2"><img id="logo" class="padding" src="images/logo.png" alt="logo image"></div>
                    <div class="col-10" id="title">u-doom</div>
                </div>
            </div>
            <div id="subtitle" class="dark-panel">
                <div class="container">
                    <div class="row">
                        Streaming Doom over BLE to a WebBluetooth application
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="container grow-w">
        <div class="row">
            <div class="col text-center">
                Receiving data
            </div>
            <div class="col text-center">
                Logs
            </div>
        </div>
        <div class="row">
            <div class="col align-center">
                <div id="doom-panel">
                    <canvas id="video-canvas"></canvas>
                    <div id="status-panel">
                        <div id="status-icon"></div>
                        <div id="status-text">Not Connected</div>
                    </div>
                </div>
            </div>
            <div class="col" id="doom-feedback-panel">
                <textarea id="feedback-text" readonly></textarea>
            </div>
        </div>
        <div class="row">
            <div class="col" id="doom-action-panel">
                <div class="col align-center" id="ble-panel">
                    <button id="connect" class="btn btn-success">CONNECT</button>
                    <button id="disconnect" class="btn btn-danger">DISCONNECT</button>
                </div>
            </div>
        </div>
    </main>
    <footer class="row dark-panel grow-w">
        <div class="col">
        </div>
    </footer>
</body>
</html>
<!DOCTYPE html>

<script>

const IMAGE_WIDTH = 640;
const IMAGE_HEIGTH = 400;

function arrayToBase64(bytes) {
    let binary = '';
    let len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
	
    return window.btoa(binary);
}

const DoomPanel = (() => {
    const CANVAS_ID = 'video-canvas';
    let ctx = null;

    (function initialize() {
        const canvas = document.getElementById(CANVAS_ID);
        ctx = canvas.getContext("2d");
    })();

    drawImage = (bytearray) => {
		let b64 = arrayToBase64(bytearray);
		let img = new Image(IMAGE_WIDTH, IMAGE_HEIGTH);
		img.src = "data:image/png;base64," + b64;
		ctx.drawImage(img, 0, 0);
    };

    return {
        drawImage
    }

})();

const StatusPanel = (() => {
    const STATUS_PANEL_ID = 'status-panel';
    const STATUS_TEXT_ID = 'status-text';
    const STATUS_ICON_ID = 'status-icon';
    let statusText = null;
    let statusIcon = null;

    (function initialize() {
        const statusPanel = document.getElementById(STATUS_PANEL_ID);
        statusText = statusPanel.querySelector(`#${STATUS_TEXT_ID}`);
        statusIcon = statusPanel.querySelector(`#${STATUS_ICON_ID}`);
    })();

    const connect = () => {
        statusText.innerHTML = 'Connected';
        statusIcon.classList.add("connected");
    };

    const disconnect = () => {
        statusText.innerHTML = 'Not Connected';
        statusIcon.classList.remove("connected");
    };

    return {
        connect,
        disconnect
    }
})();

const FeedbackPanel = (() => {
    const FEEDBACK_PANEL_ID = 'doom-feedback-panel';
    const FEEDBACK_TEXT_ID = 'feedback-text';
    let textFeedback = null;

    (function initialize() {
        const feedbackPanel = document.getElementById(FEEDBACK_PANEL_ID);
        textFeedback = feedbackPanel.querySelector(`#${FEEDBACK_TEXT_ID}`);
    })();

    const addText = (text) => {
        textFeedback.value = text + '\n' + textFeedback.value; 
        console.log(text);
    };

    return {
        addText
    }
})();

const NINA_SPS_SERVICE = '2456e1b9-26e2-8f83-e744-f34f01e9d701';
const NINA_SPS_CHARACTERISTIC = '2456e1b9-26e2-8f83-e744-f34f01e9d703';
const NINA_NAME = "NINA-W1-B9E61A";
window.device;
const SizeOfUint32 = 4;
let imageByteArray = new Uint8Array(IMAGE_WIDTH * IMAGE_HEIGTH * SizeOfUint32);
const startOfFrame = new Uint8Array([0xCA, 0xFE, 0xBA, 0xBE]);
const endOfFrame = new Uint8Array([0xDE, 0xAD, 0xBE, 0xEF]);
let frameOffset = 0;
let frameTransmission = false;
let numberOfBytes = 0;
let receivingFrameSize = 0;

function compareArray4Bytes(a1, a2) {
	if (a1.getUint8(0) == a2[0] &&
		a1.getUint8(1) == a2[1] &&
		a1.getUint8(2) == a2[2] &&
		a1.getUint8(3) == a2[3]) {
		return true;
	}
	
	return false;
}

function handleCharacteristicValueChanged(event) {
	const value = event.target.value;
	const bufferLength = value.buffer.byteLength;
	// Probably start or end of frame
	if (bufferLength == 8 && compareArray4Bytes(value, startOfFrame) == true) {
		frameTransmission = true;
		receivingFrameSize = value.getUint32(4);
		console.log('startOfFrame, size = ', receivingFrameSize);
	} else if (frameTransmission == true) {
		for (let i = 0; i < bufferLength; i++) {
			imageByteArray[frameOffset + i] = value.getUint8(i);
		}
		frameOffset += bufferLength;
		numberOfBytes += bufferLength;
		console.log('bufferLength = ', bufferLength);
		
		if (numberOfBytes == receivingFrameSize) {
			console.log('Drawing frame');
			DoomPanel.drawImage(imageByteArray);
			console.log('numberOfBytes = ', numberOfBytes);
			numberOfBytes = 0;
			receivingFrameSize = 0;
			frameOffset = 0;
			frameTransmission = false;
		}
	} else {
		console.log('Unknown state, bufferLength = ', bufferLength); 
	}
}

const openDevice = async (device) => {
    const server = await device.gatt.connect();
    
    try {
        const service = await server.getPrimaryService(NINA_SPS_SERVICE);
		const characteristic = await service.getCharacteristic(NINA_SPS_CHARACTERISTIC);
		characteristic.startNotifications();
		characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

        StatusPanel.connect();
        FeedbackPanel.addText(`Connected to ${device.name}`);

        device.ongattserverdisconnected = _ => {
            StatusPanel.disconnect();
            FeedbackPanel.addText(`Disconnected ${device.id}`);
        };
    } catch (err) {
        console.warn(err);
    }
}

const scan = async () => {
    try {
        device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [NINA_SPS_SERVICE] }]
        });

        await openDevice(device);
    } catch (err) {
        // ignore if we didn't get a device
    }
}

const disconnect = async () => {
	await device.gatt.disconnect();
}

const init = () => {
    document.querySelector('#connect').addEventListener('click', scan);
	document.querySelector('#disconnect').addEventListener('click', disconnect);
}

window.addEventListener('load', init);

// register key listener
document.onkeydown = (e) => {
    e = e || window.event;

    if (e.keyCode === 38) {
        console.log('↑');
    } else if (e.keyCode === 40) {
        console.log('↓');
    } else if (e.keyCode === 37) {
        console.log('←');
    } else if (e.keyCode === 39) {
        console.log('→');
    } else if (e.ctrlKey) {
        console.log('Ctrl');
    } else if (e.keyCode === 13) {
        console.log('Enter');
    }

}

</script>
