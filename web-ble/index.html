<!DOCTYPE html>
<html>
    <h1>u-doom</h1>
	<h2>Streaming Doom over BLE to a WebBluetooth application</h2>
    <h3 id="status">Not Connected</h3>
    <button id="connect">CONNECT</button>
	<button id="disconnect">DISCONNECT</button>
</html>

<script>

const IMAGE_WIDTH = 640;
const IMAGE_HEIGTH = 400;

const VideoDisplay = (() => {
    const CANVAS_ID = 'video-canvas';
    let ctx = null;

    createCanvas = () => {
        const canvas = document.createElement('canvas');
        canvas.id = CANVAS_ID;
        canvas.width = IMAGE_WIDTH;
        canvas.height = IMAGE_HEIGTH;
        ctx = canvas.getContext("2d");
        document.body.appendChild(canvas);
        return canvas;
    };

    drawImage = (bytearray) => {
        // Initialize a new ImageData object
		let imageArray = new Uint8ClampedArray(bytearray)
        let imageData = new ImageData(imageArray, IMAGE_WIDTH, IMAGE_HEIGTH);
        // Draw image data to the canvas
        ctx.putImageData(imageData, 0, 0);
		console.log('Image data length: ' + bytearray.byteLength);
		//let decoder = new TextDecoder("utf-8");
		//let str = decoder.decode(value);
		//console.log('Image data: ' + str);
    };

    initialize = () => {
        createCanvas();
    };

    return {
        initialize,
        drawImage
    }

})();


const NINA_SPS_SERVICE = '2456e1b9-26e2-8f83-e744-f34f01e9d701';
const NINA_SPS_CHARACTERISTIC = '2456e1b9-26e2-8f83-e744-f34f01e9d703';
const NINA_NAME = "NINA-W1-B9E61A";
const SINGLE_PACKET_SIZE = 200;
window.device;
let imageByteArray = new Uint8Array(IMAGE_WIDTH * IMAGE_HEIGTH * 4);
const startOfFrame = new Uint8Array([0xCA, 0xFE, 0xBA, 0xBE]);
const endOfFrame = new Uint8Array([0xDE, 0xAD, 0xBE, 0xEF]);
let frameOffset = 0;
let frameTransmission = false;

function compareArray4Bytes(a1, a2) {
	if (a1.getUint8(0) == a2[0] &&
		a1.getUint8(1) == a2[1] &&
		a1.getUint8(2) == a2[2] &&
		a1.getUint8(3) == a2[3]) {
		return true;
	}
	
	return false;
}

function handleCharacteristicValueChanged(event) {
	const value = event.target.value;
  
	// Probably start or end of frame
	if (value.buffer.byteLength == 4) {
		if (compareArray4Bytes(value, startOfFrame) == true) {
		console.log('startOfFrame'); 
		frameTransmission = true;
		} else if (compareArray4Bytes(value, endOfFrame) == true) {
			frameTransmission = false;
			frameOffset = 0;
			VideoDisplay.drawImage(imageByteArray);
			console.log('endOfFrame'); 
		} else {
			console.log("Size 4, but neither SOF nor EOF: 0x" + 
						value.getUint8(0).toString(16) + " 0x" + 
						value.getUint8(1).toString(16) + " 0x" +
						value.getUint8(2).toString(16) + " 0x" +
						value.getUint8(3).toString(16));
		}
	}
	
	if (value.buffer.byteLength == SINGLE_PACKET_SIZE && frameTransmission == true) {
		for (let i = 0; i < SINGLE_PACKET_SIZE; i++) {
			imageByteArray[frameOffset + i] = value.getUint8(i);
		}
		frameOffset += SINGLE_PACKET_SIZE;
	}
}

const openDevice = async (device) => {
    const server = await device.gatt.connect();
    
    try {
        const service = await server.getPrimaryService(NINA_SPS_SERVICE);
		const characteristic = await service.getCharacteristic(NINA_SPS_CHARACTERISTIC);
		characteristic.startNotifications();
		characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
        console.log('Connected to device', device);
        statusElement.innerHTML = `Connected to ${device.name}`

        device.ongattserverdisconnected = _ => {
            console.log(`Disconnected ${device.id}`);
            statusElement.innerHTML = "Not Connected";
        };
    } catch (err) {
        console.warn(err);
    }
}

const scan = async () => {
    try {
        device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [NINA_SPS_SERVICE] }]
        });

        await openDevice(device);
    } catch (err) {
        // ignore if we didn't get a device
    }
}

const disconnect = async () => {
	await device.gatt.disconnect();
}

const init = () => {
    document.querySelector('#connect').addEventListener('click', scan);
	document.querySelector('#disconnect').addEventListener('click', disconnect);
    statusElement = document.querySelector('#status');
    // add canvas in the document.body, later we can review the position and move to the html
    VideoDisplay.initialize();
}

window.addEventListener('load', init);

// register key listener
document.onkeydown = (e) => {
    e = e || window.event;

    if (e.keyCode === 38) {
        console.log('↑');
    } else if (e.keyCode === 40) {
        console.log('↓');
    } else if (e.keyCode === 37) {
        console.log('←');
    } else if (e.keyCode === 39) {
        console.log('→');
    } else if (e.ctrlKey) {
        console.log('Ctrl');
    } else if (e.keyCode === 13) {
        console.log('Enter');
    }

}

</script>
