<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>u-doom: Streaming Doom over BLE to a WebBluetooth application</title>
    <link rel="icon" type="image/png" href="images/favicon.ico">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="stylesheet" href="css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <header class="grow-w">
        <div>
            <div class="container">
                <div class="row">
                    <div class="col-2"><img id="logo" class="padding" src="images/logo.png" alt="logo image"></div>
                    <div class="col-10" id="title">u-doom</div>
                </div>
            </div>
            <div id="subtitle" class="dark-panel">
                <div class="container">
                    <div class="row">
                        Streaming Doom over BLE to a WebBluetooth application
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="container grow-w">
        <div class="row">
            <div class="col text-center">
                Receiving data
            </div>
            <div class="col text-center">
                Sending data
            </div>
        </div>
        <div class="row">
            <div class="col" id="doom-panel">
                <canvas id="video-canvas"></canvas>
                <div id="status-panel">
                    <div id="status-icon"></div>
                    <div id="status">Not Connected</div>
                </div>
            </div>
            <div class="col" id="doom-feedback-panel">
                <textarea id="feedback" readonly></textarea>
            </div>
        </div>
        <div class="row">
            <div class="col" id="doom-action-panel">
                <div class="col" id="ble-panel">
                    <button id="connect" class="btn btn-success">CONNECT</button>
                    <button id="disconnect" class="btn btn-danger">DISCONNECT</button>
                </div>
            </div>
        </div>
    </main>
    <footer class="row dark-panel grow-w">
        <div class="col">
        </div>
    </footer>
</body>
</html>
<!DOCTYPE html>

<script>

const IMAGE_WIDTH = 640;
const IMAGE_HEIGTH = 400;

const VideoDisplay = (() => {
    const CANVAS_ID = 'video-canvas';
    let ctx = null;

    loadContext = () => {
        const canvas = document.getElementById(CANVAS_ID);
        ctx = canvas.getContext("2d");
    };

    drawImage = (bytearray) => {
        // Initialize a new ImageData object
		let imageArray = new Uint8ClampedArray(bytearray)
        let imageData = new ImageData(imageArray, IMAGE_WIDTH, IMAGE_HEIGTH);
        // Draw image data to the canvas
        ctx.putImageData(imageData, 0, 0);
		console.log('Image data length: ' + bytearray.byteLength);
		//let decoder = new TextDecoder("utf-8");
		//let str = decoder.decode(value);
		//console.log('Image data: ' + str);
    };

    initialize = () => {
        loadContext();
    };

    return {
        initialize,
        drawImage
    }

})();


const NINA_SPS_SERVICE = '2456e1b9-26e2-8f83-e744-f34f01e9d701';
const NINA_SPS_CHARACTERISTIC = '2456e1b9-26e2-8f83-e744-f34f01e9d703';
const NINA_NAME = "NINA-W1-B9E61A";
const SINGLE_PACKET_SIZE = 200;
window.device;
let imageByteArray = new Uint8Array(IMAGE_WIDTH * IMAGE_HEIGTH * 4);
const startOfFrame = new Uint8Array([0xCA, 0xFE, 0xBA, 0xBE]);
const endOfFrame = new Uint8Array([0xDE, 0xAD, 0xBE, 0xEF]);
let frameOffset = 0;
let frameTransmission = false;

function compareArray4Bytes(a1, a2) {
	if (a1.getUint8(0) == a2[0] &&
		a1.getUint8(1) == a2[1] &&
		a1.getUint8(2) == a2[2] &&
		a1.getUint8(3) == a2[3]) {
		return true;
	}
	
	return false;
}

function handleCharacteristicValueChanged(event) {
	const value = event.target.value;
  
	// Probably start or end of frame
	if (value.buffer.byteLength == 4) {
		if (compareArray4Bytes(value, startOfFrame) == true) {
		console.log('startOfFrame'); 
		frameTransmission = true;
		} else if (compareArray4Bytes(value, endOfFrame) == true) {
			frameTransmission = false;
			frameOffset = 0;
			VideoDisplay.drawImage(imageByteArray);
			console.log('endOfFrame'); 
		} else {
			console.log("Size 4, but neither SOF nor EOF: 0x" + 
						value.getUint8(0).toString(16) + " 0x" + 
						value.getUint8(1).toString(16) + " 0x" +
						value.getUint8(2).toString(16) + " 0x" +
						value.getUint8(3).toString(16));
		}
	}
	
	if (value.buffer.byteLength == SINGLE_PACKET_SIZE && frameTransmission == true) {
		for (let i = 0; i < SINGLE_PACKET_SIZE; i++) {
			imageByteArray[frameOffset + i] = value.getUint8(i);
		}
		frameOffset += SINGLE_PACKET_SIZE;
	}
}

const openDevice = async (device) => {
    const server = await device.gatt.connect();
    
    try {
        const service = await server.getPrimaryService(NINA_SPS_SERVICE);
		const characteristic = await service.getCharacteristic(NINA_SPS_CHARACTERISTIC);
		characteristic.startNotifications();
		characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
        console.log('Connected to device', device);
        statusElement.innerHTML = `Connected to ${device.name}`

        device.ongattserverdisconnected = _ => {
            console.log(`Disconnected ${device.id}`);
            statusElement.innerHTML = "Not Connected";
        };
    } catch (err) {
        console.warn(err);
    }
}

const scan = async () => {
    try {
        device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [NINA_SPS_SERVICE] }]
        });

        await openDevice(device);
    } catch (err) {
        // ignore if we didn't get a device
    }
}

const disconnect = async () => {
	await device.gatt.disconnect();
}

const init = () => {
    document.querySelector('#connect').addEventListener('click', scan);
	document.querySelector('#disconnect').addEventListener('click', disconnect);
    statusElement = document.querySelector('#status');
    // add canvas in the doom-panel, later we can review the position and move to the html
    VideoDisplay.initialize('doom-panel');
}

window.addEventListener('load', init);

// register key listener
document.onkeydown = (e) => {
    e = e || window.event;

    if (e.keyCode === 38) {
        console.log('↑');
    } else if (e.keyCode === 40) {
        console.log('↓');
    } else if (e.keyCode === 37) {
        console.log('←');
    } else if (e.keyCode === 39) {
        console.log('→');
    } else if (e.ctrlKey) {
        console.log('Ctrl');
    } else if (e.keyCode === 13) {
        console.log('Enter');
    }

}

</script>
